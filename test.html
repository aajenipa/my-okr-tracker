<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live OKR Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .tab-button.active { border-color: #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        [contenteditable="true"]:focus { outline: 2px solid #4f46e5; background-color: #fff; border-radius: 4px; }
        th, td { border: 1px solid #e5e7eb; padding: 12px; text-align: left; vertical-align: middle; }
        th { background-color: #f9fafb; font-weight: 600; }
        .table-container { overflow-x: auto; }
        .add-row-btn { transition: all 0.2s ease-in-out; }
        .add-row-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .date-input, .type-select, .quarter-select { background-color: transparent; border: none; padding: 0; width: 100%; }
        .date-input:focus, .type-select:focus, .quarter-select:focus { outline: none; box-shadow: none; }
        #loader { display: flex; }
        .control-arrow, .sort-arrow { cursor: pointer; }
        .control-arrow:hover, .sort-arrow:hover { color: #4f46e5; }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 bg-gray-100 z-50 flex flex-col justify-center items-center p-4">
        <div class="w-full max-w-sm bg-white p-8 rounded-2xl shadow-lg">
            <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">My OKR Tracker</h1>
            <p id="auth-error" class="text-red-500 text-sm text-center mb-4 h-5"></p>
            <form id="email-form" class="space-y-4">
                <input id="email-input" type="email" placeholder="Email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input id="password-input" type="password" placeholder="Password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="email-signin-btn" type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">Sign In</button>
                <button id="email-signup-btn" type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 hidden">Create Account</button>
            </form>
            <p class="text-center text-sm text-gray-500 my-4">
                <span id="form-toggle-text">Need an account?</span>
                <button id="form-toggle-btn" class="font-semibold text-indigo-600 hover:underline">Sign Up</button>
            </p>
            <div class="flex items-center my-4">
                <hr class="flex-grow border-t border-gray-300"><span class="mx-4 text-gray-500 text-sm">OR</span><hr class="flex-grow border-t border-gray-300">
            </div>
            <div class="space-y-3">
                <button id="google-signin-btn" class="w-full bg-white text-gray-700 font-semibold py-2 px-6 border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50 flex items-center justify-center">
                    <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48"><path fill="#4285F4" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4 12.955 4 4 12.955 4 24s8.955 20 20 20 20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#34A853" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4 16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#FBBC05" d="M24 48c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 41.258 16.227 48 24 48z"></path><path fill="#EA4335" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C44.438 36.372 48 30.656 48 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                    Sign in with Google
                </button>
                <button id="guest-signin-btn" class="w-full text-sm text-gray-600 hover:underline">Continue as Guest</button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loader" class="fixed inset-0 bg-white bg-opacity-75 z-50 justify-center items-center hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div>
    </div>

    <div id="app-content" class="max-w-7xl mx-auto bg-white p-6 rounded-2xl shadow-lg hidden">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">My OKR Tracker</h1>
                <p class="mt-1 text-gray-500">Track activities and summarize quarterly achievements.</p>
            </div>
            <div class="mt-4 sm:mt-0 text-right">
                <span id="currentDate" class="text-sm text-gray-500 block"></span>
                <div class="text-xs text-gray-400 mt-1">User: <span id="userName" class="font-semibold"></span></div>
                <button id="sign-out-btn" class="text-xs text-indigo-600 hover:underline mt-1">Sign Out</button>
            </div>
        </div>
        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                <button onclick="changeTab(event, 'activity')" class="tab-button active whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-lg">Activity Tracker</button>
                <button onclick="changeTab(event, 'summary')" class="tab-button whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-lg">Quarterly Summary</button>
            </nav>
        </div>
        <div>
            <div id="activity" class="tab-content active">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-xl font-semibold text-gray-700">Weekly Activity Log</h2>
                    <div class="flex items-end space-x-2 sm:space-x-4 flex-wrap">
                        <div class="text-sm"><label for="start-date-filter" class="font-medium text-gray-600">Start Date:</label><input type="date" id="start-date-filter" class="p-2 border rounded-md bg-white"></div>
                        <div class="text-sm"><label for="end-date-filter" class="font-medium text-gray-600">End Date:</label><input type="date" id="end-date-filter" class="p-2 border rounded-md bg-white"></div>
                        <div class="text-sm"><label for="working-hours" class="font-medium text-gray-600">Weekly Hours:</label><input type="number" id="working-hours" value="40" class="w-20 p-2 border rounded-md text-center"></div>
                    </div>
                </div>
                <div id="utilization-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div>
                <div class="table-container">
                    <table id="activity-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr><th>Week</th><th class="flex items-center">Date <span id="date-sort-btn" class="ml-2 sort-arrow">â†“</span></th><th>Type</th><th>Project / Work-stream</th><th>Action / Task Completed</th><th>Status</th><th>Total Hours</th><th>Billable Hours</th><th>Actions</th></tr></thead>
                        <tbody class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <button id="add-activity-row-btn" class="add-row-btn mt-4 bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg hover:bg-indigo-200"> + Add Activity Row </button>
            </div>
            <div id="summary" class="tab-content">
                 <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-xl font-semibold text-gray-700">Quarterly Achievements Summary</h2>
                    <div class="text-sm"><label for="quarter-filter" class="font-medium text-gray-600">Filter by Quarter:</label><select id="quarter-filter" class="p-2 border rounded-md bg-white"></select></div>
                 </div>
                 <div id="quarterly-summary-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"></div>
                 <div id="objectives-container" class="space-y-8"></div>
                 <button id="add-objective-btn" class="add-row-btn mt-6 bg-green-100 text-green-800 px-4 py-2 rounded-lg hover:bg-green-200">+ Add New Objective</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, EmailAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, signOut, linkWithCredential } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, setDoc, deleteDoc, onSnapshot, query, getDocs, writeBatch, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAAhK518n0CoogsD84u_5Wa65IQrnphpbg",
            authDomain: "my-okr-tracker-a77ed.firebaseapp.com",
            projectId: "my-okr-tracker-a77ed",
            storageBucket: "my-okr-tracker-a77ed.appspot.com",
            messagingSenderId: "344615597808",
            appId: "1:344615597808:web:a976849992dc0f9a5d3435",
            measurementId: "G-BQW8HWHBM3"
        };

        // --- App State ---
        let db, auth, userId;
        let activitiesUnsubscribe = () => {};
        let objectivesUnsubscribe = () => {};
        let objectivesCache = [];
        let activitiesCache = [];
        let dateSortDirection = 'desc';
        let isSigningUp = false;

        // --- UI Elements ---
        const loginScreen = document.getElementById('login-screen');
        const loader = document.getElementById('loader');
        const appContent = document.getElementById('app-content');
        const activityTableBody = document.getElementById('activity-table').querySelector('tbody');
        const objectivesContainer = document.getElementById('objectives-container');

        // --- General UI Functions ---
        const showLogin = () => { loginScreen.style.display = 'flex'; loader.style.display = 'none'; appContent.classList.add('hidden'); };
        const showLoader = () => { loginScreen.style.display = 'none'; loader.style.display = 'flex'; appContent.classList.add('hidden'); };
        const showApp = () => { loginScreen.style.display = 'none'; loader.style.display = 'none'; appContent.classList.remove('hidden'); };
        
        window.changeTab = (event, tabID) => {
            document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = "none");
            document.querySelectorAll('.tab-button').forEach(tb => tb.classList.remove('active'));
            document.getElementById(tabID).style.display = "block";
            event.currentTarget.classList.add('active');
        };

        // --- Authentication Functions ---
        const signInWithGoogle = async () => { /* ... */ };
        const signOutUser = () => signOut(auth);
        const handleEmailAuth = async (event) => { /* ... */ };
        const toggleAuthForm = () => { /* ... */ };

        // --- Activity Tracker Logic ---
        const getWeekNumber = (d) => { /* ... */ };
        const getQuarterFromWeek = (week) => { /* ... */ };
        const getQuarterFromDate = (date) => { /* ... */ };
        
        const filterActivities = () => {
            const startDateFilter = document.getElementById('start-date-filter').value;
            const endDateFilter = document.getElementById('end-date-filter').value;
            
            const start = startDateFilter ? new Date(startDateFilter) : null;
            const end = endDateFilter ? new Date(endDateFilter) : null;

            if(start) start.setUTCHours(0,0,0,0);
            if(end) end.setUTCHours(23,59,59,999);

            document.querySelectorAll('#activity-table tbody tr').forEach(row => {
                const activityDateStr = row.querySelector('.date-input').value;
                if (!activityDateStr) { row.style.display = 'none'; return; }
                const activityDate = new Date(activityDateStr);
                
                const isAfterStart = !start || activityDate >= start;
                const isBeforeEnd = !end || activityDate <= end;

                row.style.display = (isAfterStart && isBeforeEnd) ? '' : 'none';
            });
            calculateUtilization();
        };
        
        const calculateUtilization = () => { /* ... */ };
        const renderActivityTable = () => { /* ... */ };
        const toggleDateSort = () => { /* ... */ };
        const addActivityRow = () => { /* ... */ };
        const updateActivity = (id, data) => { /* ... */ };
        const deleteActivity = (id) => { /* ... */ };
        
        // --- Objectives Logic ---
        const updateProgress = () => { /* ... */ };
        const populateQuarterFilter = () => { /* ... */ };
        const filterSummaryByQuarter = () => { /* ... */ };
        const renderQuarterlySummaryCards = () => { /* ... */ };
        const handleQuarterFilterChange = () => { /* ... */ };
        const renderObjectives = () => { /* ... */ };
        const addObjective = () => { /* ... */ };
        const updateObjective = (id, data) => { /* ... */ };
        const deleteObjective = (id) => { /* ... */ };
        const addKR = (id, krs) => { /* ... */ };
        const deleteKR = (id, krs, index) => { /* ... */ };
        const moveObjective = async (index, direction) => { /* ... */ };

        // --- Firebase Initialization and Auth ---
        async function seedInitialData(userId) { /* ... */ }
        
        async function initialize() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Event Delegation for dynamic content
                document.body.addEventListener('click', (e) => { /* ... */ });
                document.body.addEventListener('blur', (e) => { /* ... */ }, true);
                document.body.addEventListener('change', (e) => { /* ... */ });

                // Static Listeners
                document.getElementById('google-signin-btn').addEventListener('click', signInWithGoogle);
                document.getElementById('guest-signin-btn').addEventListener('click', () => signInAnonymously(auth));
                document.getElementById('sign-out-btn').addEventListener('click', signOutUser);
                document.getElementById('email-form').addEventListener('submit', handleEmailAuth);
                document.getElementById('form-toggle-btn').addEventListener('click', toggleAuthForm);
                document.getElementById('add-activity-row-btn').addEventListener('click', addActivityRow);
                document.getElementById('add-objective-btn').addEventListener('click', addObjective);
                document.getElementById('date-sort-btn').addEventListener('click', toggleDateSort);
                document.getElementById('start-date-filter').addEventListener('change', filterActivities);
                document.getElementById('end-date-filter').addEventListener('change', filterActivities);
                document.getElementById('quarter-filter').addEventListener('change', handleQuarterFilterChange);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userName').textContent = user.displayName || (user.isAnonymous ? 'Guest' : user.email);
                        showLoader();
                        await seedInitialData(userId);
                        if (activitiesUnsubscribe) activitiesUnsubscribe();
                        if (objectivesUnsubscribe) objectivesUnsubscribe();
                        const activitiesQuery = query(collection(db, `users/${userId}/activities`));
                        activitiesUnsubscribe = onSnapshot(activitiesQuery, snapshot => {
                            activitiesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            renderActivityTable();
                            renderQuarterlySummaryCards();
                        });
                        const objectivesQuery = query(collection(db, `users/${userId}/objectives`), orderBy("order"));
                        objectivesUnsubscribe = onSnapshot(objectivesQuery, snapshot => {
                            objectivesCache = snapshot.docs;
                            renderObjectives();
                            renderQuarterlySummaryCards();
                        });
                        showApp();
                    } else {
                        if (activitiesUnsubscribe) activitiesUnsubscribe();
                        if (objectivesUnsubscribe) objectivesUnsubscribe();
                        activitiesCache = []; objectivesCache = [];
                        showLogin();
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                loader.innerHTML = "Failed to load application. Check console for errors.";
            }
        }

        initialize();
    </script>
</body>
</html>
