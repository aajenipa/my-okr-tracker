<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live OKR Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .tab-button.active { border-color: #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        [contenteditable="true"]:focus { outline: 2px solid #4f46e5; background-color: #fff; border-radius: 4px; }
        th, td { border: 1px solid #e5e7eb; padding: 12px; text-align: left; vertical-align: middle; }
        th { background-color: #f9fafb; font-weight: 600; }
        .table-container { overflow-x: auto; }
        .add-row-btn { transition: all 0.2s ease-in-out; }
        .add-row-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .date-input { background-color: transparent; border: none; padding: 0; width: 100%; min-width: 130px; }
        .date-input:focus { outline: none; box-shadow: none; }
        #loader { display: flex; }
        .control-arrow, .sort-arrow { cursor: pointer; }
        .control-arrow:hover, .sort-arrow:hover { color: #4f46e5; }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 bg-gray-100 z-50 flex flex-col justify-center items-center p-4">
        <div class="w-full max-w-sm bg-white p-8 rounded-2xl shadow-lg">
            <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">My OKR Tracker</h1>
            <p id="auth-error" class="text-red-500 text-sm text-center mb-4 h-5"></p>
            <form id="email-form" class="space-y-4">
                <input id="email-input" type="email" placeholder="Email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input id="password-input" type="password" placeholder="Password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="email-signin-btn" type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">Sign In</button>
                <button id="email-signup-btn" type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 hidden">Create Account</button>
            </form>
            <p class="text-center text-sm text-gray-500 my-4">
                <span id="form-toggle-text">Need an account?</span>
                <button id="form-toggle-btn" class="font-semibold text-indigo-600 hover:underline">Sign Up</button>
            </p>
            <div class="flex items-center my-4">
                <hr class="flex-grow border-t border-gray-300"><span class="mx-4 text-gray-500 text-sm">OR</span><hr class="flex-grow border-t border-gray-300">
            </div>
            <div class="space-y-3">
                <button id="google-signin-btn" class="w-full bg-white text-gray-700 font-semibold py-2 px-6 border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50 flex items-center justify-center">
                    <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48"><path fill="#4285F4" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4 12.955 4 4 12.955 4 24s8.955 20 20 20 20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#34A853" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4 16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#FBBC05" d="M24 48c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 41.258 16.227 48 24 48z"></path><path fill="#EA4335" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C44.438 36.372 48 30.656 48 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                    Sign in with Google
                </button>
                <button id="guest-signin-btn" class="w-full text-sm text-gray-600 hover:underline">Continue as Guest</button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loader" class="fixed inset-0 bg-white bg-opacity-75 z-50 justify-center items-center hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div>
    </div>

    <div id="app-content" class="max-w-7xl mx-auto bg-white p-6 rounded-2xl shadow-lg hidden">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">My OKR Tracker</h1>
                <p class="mt-1 text-gray-500">Track activities and summarize quarterly achievements.</p>
            </div>
            <div class="mt-4 sm:mt-0 text-right">
                <span id="currentDate" class="text-sm text-gray-500 block"></span>
                <div class="text-xs text-gray-400 mt-1">User: <span id="userName" class="font-semibold"></span></div>
                <button id="sign-out-btn" class="text-xs text-indigo-600 hover:underline mt-1">Sign Out</button>
            </div>
        </div>
        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                <button onclick="changeTab(event, 'activity')" class="tab-button active whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-lg">Activity Tracker</button>
                <button onclick="changeTab(event, 'summary')" class="tab-button whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-lg">Quarterly Summary</button>
            </nav>
        </div>
        <div>
            <div id="activity" class="tab-content active">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-xl font-semibold text-gray-700">Weekly Activity Log</h2>
                    <div class="flex items-center space-x-2 sm:space-x-4 flex-wrap">
                        <div class="text-sm"><label for="year-filter" class="font-medium text-gray-600">Year:</label><select id="year-filter" class="p-2 border rounded-md bg-white"></select></div>
                        <div class="text-sm"><label for="month-filter" class="font-medium text-gray-600">Month:</label><select id="month-filter" class="p-2 border rounded-md bg-white"></select></div>
                        <div class="text-sm"><label for="week-filter" class="font-medium text-gray-600">Week:</label><select id="week-filter" class="p-2 border rounded-md bg-white"></select></div>
                        <div class="text-sm"><label for="working-hours" class="font-medium text-gray-600">Weekly Hours:</label><input type="number" id="working-hours" value="40" class="w-20 p-2 border rounded-md text-center"></div>
                    </div>
                </div>
                <div id="utilization-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div>
                <div class="table-container">
                    <table id="activity-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr><th>Week</th><th class="flex items-center">Date <span id="date-sort-btn" class="ml-2 sort-arrow">↓</span></th><th>Project / Work-stream</th><th>Action / Task Completed</th><th>Status</th><th>Total Hours</th><th>Billable Hours</th><th>Actions</th></tr></thead>
                        <tbody class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <button id="add-activity-row-btn" class="add-row-btn mt-4 bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg hover:bg-indigo-200"> + Add Activity Row </button>
            </div>
            <div id="summary" class="tab-content">
                 <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-xl font-semibold text-gray-700">Quarterly Achievements Summary</h2>
                    <div class="text-sm"><label for="quarter-filter" class="font-medium text-gray-600">Filter by Quarter:</label><select id="quarter-filter" class="p-2 border rounded-md bg-white"></select></div>
                 </div>
                 <div id="quarterly-summary-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"></div>
                 <div id="objectives-container" class="space-y-8"></div>
                 <button id="add-objective-btn" class="add-row-btn mt-6 bg-green-100 text-green-800 px-4 py-2 rounded-lg hover:bg-green-200">+ Add New Objective</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, EmailAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, signOut, linkWithCredential } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, setDoc, deleteDoc, onSnapshot, query, getDocs, writeBatch, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAAhK518n0CoogsD84u_5Wa65IQrnphpbg",
            authDomain: "my-okr-tracker-a77ed.firebaseapp.com",
            projectId: "my-okr-tracker-a77ed",
            storageBucket: "my-okr-tracker-a77ed.appspot.com",
            messagingSenderId: "344615597808",
            appId: "1:344615597808:web:a976849992dc0f9a5d3435",
            measurementId: "G-BQW8HWHBM3"
        };

        // --- App State ---
        let db, auth, userId;
        let activitiesUnsubscribe = () => {};
        let objectivesUnsubscribe = () => {};
        let objectivesCache = [];
        let activitiesCache = [];
        let dateSortDirection = 'desc';
        let isSigningUp = false;

        // --- UI Elements ---
        const loginScreen = document.getElementById('login-screen');
        const loader = document.getElementById('loader');
        const appContent = document.getElementById('app-content');
        const emailForm = document.getElementById('email-form');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const emailSigninBtn = document.getElementById('email-signin-btn');
        const emailSignupBtn = document.getElementById('email-signup-btn');
        const formToggleText = document.getElementById('form-toggle-text');
        const formToggleBtn = document.getElementById('form-toggle-btn');
        const authError = document.getElementById('auth-error');
        const activityTableBody = document.getElementById('activity-table').querySelector('tbody');
        const objectivesContainer = document.getElementById('objectives-container');

        // --- General UI Functions ---
        const showLogin = () => { loginScreen.style.display = 'flex'; loader.style.display = 'none'; appContent.classList.add('hidden'); };
        const showLoader = () => { loginScreen.style.display = 'none'; loader.style.display = 'flex'; appContent.classList.add('hidden'); };
        const showApp = () => { loginScreen.style.display = 'none'; loader.style.display = 'none'; appContent.classList.remove('hidden'); };
        
        window.changeTab = (event, tabID) => {
            document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = "none");
            document.querySelectorAll('.tab-button').forEach(tb => tb.classList.remove('active'));
            document.getElementById(tabID).style.display = "block";
            event.currentTarget.classList.add('active');
        };

        // --- Authentication Functions ---
        const signInWithGoogle = async () => { /* ... (same as before) ... */ };
        const signOutUser = () => signOut(auth);
        const handleEmailAuth = async (event) => { /* ... (same as before) ... */ };
        const toggleAuthForm = () => { /* ... (same as before) ... */ };

        // --- Activity Tracker Logic ---
        const getWeekNumber = (d) => { /* ... (same as before) ... */ return 1; };
        const getQuarterFromWeek = (week) => { /* ... (same as before) ... */ return 'Q1'; };
        const populateDateFilters = () => { /* ... (same as before) ... */ };
        const filterActivities = () => { /* ... (same as before) ... */ };
        const calculateUtilization = () => { /* ... (same as before) ... */ };
        const renderActivityTable = () => { /* ... (same as before) ... */ };
        const toggleDateSort = () => { dateSortDirection = dateSortDirection === 'desc' ? 'asc' : 'desc'; document.getElementById('date-sort-btn').innerHTML = dateSortDirection === 'desc' ? '↓' : '↑'; renderActivityTable(); };
        const addActivityRow = () => addDoc(collection(db, `users/${userId}/activities`), { date: new Date().toISOString().split('T')[0], week: getWeekNumber(new Date()), project: '', action: '', status: 'New', totalHours: 0, billableHours: 0, createdAt: new Date() });
        const updateActivity = (id, data) => setDoc(doc(db, `users/${userId}/activities`, id), data, { merge: true });
        const deleteActivity = (id) => deleteDoc(doc(db, `users/${userId}/activities`, id));
        
        // --- Objectives Logic ---
        const updateProgress = () => { /* ... (same as before) ... */ };
        const populateQuarterFilter = () => { /* ... (same as before) ... */ };
        const filterSummaryByQuarter = () => { /* ... (same as before) ... */ };
        const renderQuarterlySummaryCards = () => { /* ... (same as before) ... */ };
        const handleQuarterFilterChange = () => { filterSummaryByQuarter(); renderQuarterlySummaryCards(); };
        const addObjective = () => {
            const newOrder = objectivesCache.length > 0 ? Math.max(...objectivesCache.map(o => o.data().order || 0)) + 1 : 0;
            addDoc(collection(db, `users/${userId}/objectives`), { title: 'New Objective', krs: [], order: newOrder, createdAt: new Date() });
        };
        const updateObjective = (id, data) => setDoc(doc(db, `users/${userId}/objectives`, id), data, { merge: true });
        const deleteObjective = (id) => deleteDoc(doc(db, `users/${userId}/objectives`, id));
        const addKR = (id, krs) => updateObjective(id, { krs: [...krs, { quarter: 'Q3', result: '', target: '', actual: '', notes: '' }] });
        const deleteKR = (id, krs, index) => updateObjective(id, { krs: krs.filter((_, i) => i !== index) });
        const moveObjective = async (index, direction) => { /* ... (same as before) ... */ };

        const renderObjectives = () => {
            objectivesContainer.innerHTML = '';
            objectivesCache.forEach((doc, index) => {
                const data = doc.data();
                const block = document.createElement('div');
                block.className = 'objective-block';
                block.dataset.id = doc.id;
                
                const krsHTML = (data.krs || []).map((kr, i) => `
                    <tr data-index="${i}">
                        <td contenteditable="true" class="quarter">${kr.quarter || ''}</td>
                        <td contenteditable="true">${kr.result || ''}</td>
                        <td contenteditable="true">${kr.target || ''}</td>
                        <td contenteditable="true" class="actual">${kr.actual || ''}</td>
                        <td class="progress"></td>
                        <td contenteditable="true">${kr.notes || ''}</td>
                        <td class="text-center"><button class="delete-kr-btn text-red-500 text-xs">Delete</button></td>
                    </tr>`).join('');

                block.innerHTML = `
                    <div class="bg-gray-100 p-4 rounded-lg flex justify-between items-center">
                        <div class="flex items-center">
                            <div class="flex flex-col mr-4">
                                ${index > 0 ? `<svg class="control-arrow h-5 w-5 text-gray-500 move-up" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>` : `<div class="h-5 w-5"></div>`}
                                ${index < objectivesCache.length - 1 ? `<svg class="control-arrow h-5 w-5 text-gray-500 move-down" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>` : `<div class="h-5 w-5"></div>`}
                            </div>
                            <h3 contenteditable="true" class="font-bold text-lg text-gray-800">${data.title}</h3>
                        </div>
                        <button class="delete-objective-btn text-red-500 text-xs hover:underline">Delete Objective</button>
                    </div>
                    <div class="table-container mt-2">
                        <table class="min-w-full summary-table">
                            <thead class="bg-gray-50"><tr><th>Quarter</th><th>Key Result</th><th>Target</th><th>Actual</th><th>Progress</th><th>Key Achievements & Notes</th><th>Actions</th></tr></thead>
                            <tbody>${krsHTML}</tbody>
                        </table>
                        <button class="add-kr-btn mt-2 bg-gray-100 text-xs">+ Add Key Result</button>
                    </div>`;
                objectivesContainer.appendChild(block);
            });
            updateProgress();
            populateQuarterFilter();
            filterSummaryByQuarter();
        };

        // --- Firebase Initialization and Auth ---
        
        async function seedInitialData(userId) { /* ... (same as before) ... */ }
        
        async function initialize() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Event Listeners using Delegation
                objectivesContainer.addEventListener('click', (e) => {
                    const target = e.target;
                    const block = target.closest('.objective-block');
                    if (!block) return;
                    const docId = block.dataset.id;
                    const objIndex = objectivesCache.findIndex(d => d.id === docId);

                    if (target.classList.contains('delete-objective-btn')) deleteObjective(docId);
                    else if (target.classList.contains('add-kr-btn')) addKR(docId, objectivesCache[objIndex].data().krs || []);
                    else if (target.closest('.move-up')) moveObjective(objIndex, 'up');
                    else if (target.closest('.move-down')) moveObjective(objIndex, 'down');
                    else if (target.classList.contains('delete-kr-btn')) {
                        const krIndex = parseInt(target.closest('tr').dataset.index);
                        deleteKR(docId, objectivesCache[objIndex].data().krs || [], krIndex);
                    }
                });

                objectivesContainer.addEventListener('blur', (e) => {
                    const target = e.target;
                    const block = target.closest('.objective-block');
                    if (!block) return;
                    const docId = block.dataset.id;
                    const objIndex = objectivesCache.findIndex(d => d.id === docId);
                    
                    if (target.tagName === 'H3') {
                        updateObjective(docId, { title: target.textContent });
                    } else if (target.closest('tr')) {
                        const krIndex = parseInt(target.closest('tr').dataset.index);
                        const cellIndex = target.closest('td').cellIndex;
                        const field = ['quarter', 'result', 'target', 'actual', 'notes'][cellIndex];
                        const krs = objectivesCache[objIndex].data().krs || [];
                        krs[krIndex][field] = target.textContent;
                        updateObjective(docId, { krs });
                    }
                }, true); // Use capture phase for blur events

                // Other Listeners
                document.getElementById('google-signin-btn').addEventListener('click', signInWithGoogle);
                document.getElementById('guest-signin-btn').addEventListener('click', () => signInAnonymously(auth));
                document.getElementById('sign-out-btn').addEventListener('click', signOutUser);
                emailForm.addEventListener('submit', handleEmailAuth);
                formToggleBtn.addEventListener('click', toggleAuthForm);
                document.getElementById('add-activity-row-btn').addEventListener('click', addActivityRow);
                document.getElementById('add-objective-btn').addEventListener('click', addObjective);
                document.getElementById('date-sort-btn').addEventListener('click', toggleDateSort);
                document.getElementById('year-filter').addEventListener('change', filterActivities);
                document.getElementById('month-filter').addEventListener('change', filterActivities);
                document.getElementById('week-filter').addEventListener('change', filterActivities);
                document.getElementById('quarter-filter').addEventListener('change', handleQuarterFilterChange);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userName').textContent = user.displayName || (user.isAnonymous ? 'Guest' : user.email);
                        
                        showLoader();
                        await seedInitialData(userId);
                        
                        if (activitiesUnsubscribe) activitiesUnsubscribe();
                        if (objectivesUnsubscribe) objectivesUnsubscribe();

                        const activitiesQuery = query(collection(db, `users/${userId}/activities`));
                        activitiesUnsubscribe = onSnapshot(activitiesQuery, snapshot => {
                            activitiesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            renderActivityTable();
                            populateDateFilters();
                            renderQuarterlySummaryCards();
                        });

                        const objectivesQuery = query(collection(db, `users/${userId}/objectives`), orderBy("order"));
                        objectivesUnsubscribe = onSnapshot(objectivesQuery, snapshot => {
                            objectivesCache = snapshot.docs;
                            renderObjectives();
                        });

                        showApp();

                    } else {
                        if (activitiesUnsubscribe) activitiesUnsubscribe();
                        if (objectivesUnsubscribe) objectivesUnsubscribe();
                        activitiesCache = [];
                        objectivesCache = [];
                        showLogin();
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                loader.innerHTML = "Failed to load application. Check console for errors.";
            }
        }

        initialize();
    </script>
</body>
</html>
