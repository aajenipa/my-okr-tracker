<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live OKR Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .tab-button.active { border-color: #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        [contenteditable="true"]:focus { outline: 2px solid #4f46e5; background-color: #fff; border-radius: 4px; }
        th, td { border: 1px solid #e5e7eb; padding: 12px; text-align: left; vertical-align: middle; }
        th { background-color: #f9fafb; font-weight: 600; }
        .table-container { overflow-x: auto; }
        .add-row-btn { transition: all 0.2s ease-in-out; }
        .add-row-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .date-input, .type-select, .quarter-select { background-color: transparent; border: none; padding: 0; width: 100%; }
        .date-input:focus, .type-select:focus, .quarter-select:focus { outline: none; box-shadow: none; }
        #loader { display: flex; }
        .control-arrow, .sort-arrow { cursor: pointer; }
        .control-arrow:hover, .sort-arrow:hover { color: #4f46e5; }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 bg-gray-100 z-50 flex flex-col justify-center items-center p-4">
        <div class="w-full max-w-sm bg-white p-8 rounded-2xl shadow-lg">
            <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">My OKR Tracker</h1>
            <p id="auth-error" class="text-red-500 text-sm text-center mb-4 h-5"></p>
            <form id="email-form" class="space-y-4">
                <input id="email-input" type="email" placeholder="Email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input id="password-input" type="password" placeholder="Password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="email-signin-btn" type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">Sign In</button>
                <button id="email-signup-btn" type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 hidden">Create Account</button>
            </form>
            <p class="text-center text-sm text-gray-500 my-4">
                <span id="form-toggle-text">Need an account?</span>
                <button id="form-toggle-btn" class="font-semibold text-indigo-600 hover:underline">Sign Up</button>
            </p>
            <div class="flex items-center my-4">
                <hr class="flex-grow border-t border-gray-300"><span class="mx-4 text-gray-500 text-sm">OR</span><hr class="flex-grow border-t border-gray-300">
            </div>
            <div class="space-y-3">
                <button id="google-signin-btn" class="w-full bg-white text-gray-700 font-semibold py-2 px-6 border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50 flex items-center justify-center">
                    <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48"><path fill="#4285F4" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4 12.955 4 4 12.955 4 24s8.955 20 20 20 20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#34A853" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4 16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#FBBC05" d="M24 48c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 41.258 16.227 48 24 48z"></path><path fill="#EA4335" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C44.438 36.372 48 30.656 48 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                    Sign in with Google
                </button>
                <button id="guest-signin-btn" class="w-full text-sm text-gray-600 hover:underline">Continue as Guest</button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loader" class="fixed inset-0 bg-white bg-opacity-75 z-50 justify-center items-center hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div>
    </div>

    <div id="app-content" class="max-w-7xl mx-auto bg-white p-6 rounded-2xl shadow-lg hidden">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">My OKR Tracker</h1>
                <p class="mt-1 text-gray-500">Track activities and summarize quarterly achievements.</p>
            </div>
            <div class="mt-4 sm:mt-0 text-right">
                <span id="currentDate" class="text-sm text-gray-500 block"></span>
                <div class="text-xs text-gray-400 mt-1">User: <span id="userName" class="font-semibold"></span></div>
                <button id="sign-out-btn" class="text-xs text-indigo-600 hover:underline mt-1">Sign Out</button>
            </div>
        </div>
        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                <button onclick="changeTab(event, 'activity')" class="tab-button active whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-lg">Activity Tracker</button>
                <button onclick="changeTab(event, 'summary')" class="tab-button whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-lg">Quarterly Summary</button>
            </nav>
        </div>
        <div>
            <div id="activity" class="tab-content active">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-xl font-semibold text-gray-700">Weekly Activity Log</h2>
                    <div class="flex items-end space-x-2 sm:space-x-4 flex-wrap">
                        <div class="text-sm"><label for="year-filter" class="font-medium text-gray-600">Year:</label><select id="year-filter" class="p-2 border rounded-md bg-white"></select></div>
                        <div class="text-sm"><label for="quarter-activity-filter" class="font-medium text-gray-600">Quarter:</label><select id="quarter-activity-filter" class="p-2 border rounded-md bg-white"></select></div>
                        <div class="text-sm"><label for="month-filter" class="font-medium text-gray-600">Month:</label><select id="month-filter" class="p-2 border rounded-md bg-white"></select></div>
                        <div class="text-sm"><label for="week-filter" class="font-medium text-gray-600">Week:</label><select id="week-filter" class="p-2 border rounded-md bg-white"></select></div>
                        <div class="text-sm"><label for="working-hours" class="font-medium text-gray-600">Weekly Hours:</label><input type="number" id="working-hours" value="40" class="w-20 p-2 border rounded-md text-center"></div>
                    </div>
                </div>
                <div id="utilization-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div>
                <div class="table-container">
                    <table id="activity-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr><th>Week</th><th class="flex items-center">Date <span id="date-sort-btn" class="ml-2 sort-arrow">↓</span></th><th>Type</th><th>Project / Work-stream</th><th>Action / Task Completed</th><th>Status</th><th>Total Hours</th><th>Billable Hours</th><th>Actions</th></tr></thead>
                        <tbody class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <button id="add-activity-row-btn" class="add-row-btn mt-4 bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg hover:bg-indigo-200"> + Add Activity Row </button>
            </div>
            <div id="summary" class="tab-content">
                 <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-xl font-semibold text-gray-700">Quarterly Achievements Summary</h2>
                    <div class="text-sm"><label for="quarter-filter" class="font-medium text-gray-600">Filter by Quarter:</label><select id="quarter-filter" class="p-2 border rounded-md bg-white"></select></div>
                 </div>
                 <div id="quarterly-summary-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"></div>
                 <div id="objectives-container" class="space-y-8"></div>
                 <button id="add-objective-btn" class="add-row-btn mt-6 bg-green-100 text-green-800 px-4 py-2 rounded-lg hover:bg-green-200">+ Add New Objective</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, EmailAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, signOut, linkWithCredential } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, setDoc, deleteDoc, onSnapshot, query, getDocs, writeBatch, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAAhK518n0CoogsD84u_5Wa65IQrnphpbg",
            authDomain: "my-okr-tracker-a77ed.firebaseapp.com",
            projectId: "my-okr-tracker-a77ed",
            storageBucket: "my-okr-tracker-a77ed.appspot.com",
            messagingSenderId: "344615597808",
            appId: "1:344615597808:web:a976849992dc0f9a5d3435",
            measurementId: "G-BQW8HWHBM3"
        };

        // --- App State ---
        let db, auth, userId;
        let activitiesUnsubscribe = () => {};
        let objectivesUnsubscribe = () => {};
        let objectivesCache = [];
        let activitiesCache = [];
        let dateSortDirection = 'desc';
        let isSigningUp = false;

        // --- UI Elements ---
        const loginScreen = document.getElementById('login-screen');
        const loader = document.getElementById('loader');
        const appContent = document.getElementById('app-content');
        const activityTableBody = document.getElementById('activity-table').querySelector('tbody');
        const objectivesContainer = document.getElementById('objectives-container');

        // --- General UI Functions ---
        const showLogin = () => { loginScreen.style.display = 'flex'; loader.style.display = 'none'; appContent.classList.add('hidden'); };
        const showLoader = () => { loginScreen.style.display = 'none'; loader.style.display = 'flex'; appContent.classList.add('hidden'); };
        const showApp = () => { loginScreen.style.display = 'none'; loader.style.display = 'none'; appContent.classList.remove('hidden'); };
        
        window.changeTab = (event, tabID) => {
            document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = "none");
            document.querySelectorAll('.tab-button').forEach(tb => tb.classList.remove('active'));
            document.getElementById(tabID).style.display = "block";
            event.currentTarget.classList.add('active');
        };

        // --- Authentication Functions ---
        const signInWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                if (auth.currentUser?.isAnonymous) {
                    const credential = GoogleAuthProvider.credentialFromResult(result);
                    await linkWithCredential(auth.currentUser, credential);
                }
            } catch (error) {
                document.getElementById('auth-error').textContent = error.message;
            }
        };
        const signOutUser = () => signOut(auth);
        const handleEmailAuth = async (event) => {
            event.preventDefault();
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            document.getElementById('auth-error').textContent = '';
            try {
                if (isSigningUp) {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                document.getElementById('auth-error').textContent = error.message;
            }
        };
        const toggleAuthForm = () => {
            isSigningUp = !isSigningUp;
            document.getElementById('email-signin-btn').classList.toggle('hidden');
            document.getElementById('email-signup-btn').classList.toggle('hidden');
            document.getElementById('form-toggle-text').textContent = isSigningUp ? 'Already have an account?' : 'Need an account?';
            document.getElementById('form-toggle-btn').textContent = isSigningUp ? 'Sign In' : 'Sign Up';
            document.getElementById('auth-error').textContent = '';
        };

        // --- Activity Tracker Logic ---
        const getWeekNumber = (d) => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        };
        const getQuarterFromWeek = (week) => {
            if (week <= 13) return 'Q1'; if (week <= 26) return 'Q2'; if (week <= 39) return 'Q3'; return 'Q4';
        };
        const getQuarterFromDate = (date) => {
            if (!date || isNaN(date.getTime())) { date = new Date(); }
            const month = date.getMonth(); // 0-11
            if (month < 3) return 'Q1'; if (month < 6) return 'Q2'; if (month < 9) return 'Q3'; return 'Q4';
        };

        const populateDateFilters = () => {
            const yearFilter = document.getElementById('year-filter');
            const quarterFilter = document.getElementById('quarter-activity-filter');
            const monthFilter = document.getElementById('month-filter');
            const weekFilter = document.getElementById('week-filter');

            const years = new Set();
            const quarters = new Set();
            const months = new Set();
            const weeks = new Set();

            const selectedYear = yearFilter.value;
            
            activitiesCache.forEach(activity => {
                if (!activity.date) return;
                const date = new Date(activity.date);
                if (isNaN(date.getTime())) return;
                
                years.add(date.getUTCFullYear());

                if (selectedYear === 'all' || date.getUTCFullYear().toString() === selectedYear) {
                    if(activity.week) {
                        quarters.add(getQuarterFromWeek(activity.week));
                        months.add(date.getUTCMonth());
                        weeks.add(activity.week);
                    }
                }
            });

            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

            const populate = (select, options, allLabel, formatter) => {
                const currentValue = select.value;
                select.innerHTML = `<option value="all">${allLabel}</option>`;
                Array.from(options).sort((a,b) => a-b).forEach(opt => {
                    select.innerHTML += `<option value="${opt}">${formatter(opt)}</option>`;
                });
                select.value = Array.from(select.options).some(o => o.value === currentValue) ? currentValue : 'all';
            };

            populate(yearFilter, years, 'All Years', y => y);
            populate(quarterFilter, quarters, 'All Quarters', q => q);
            populate(monthFilter, months, 'All Months', m => monthNames[m]);
            populate(weekFilter, weeks, 'All Weeks', w => `Week ${w}`);
        };

        const filterActivities = () => {
            const year = document.getElementById('year-filter').value;
            const quarter = document.getElementById('quarter-activity-filter').value;
            const month = document.getElementById('month-filter').value;
            const week = document.getElementById('week-filter').value;

            document.querySelectorAll('#activity-table tbody tr').forEach(row => {
                const activityDateStr = row.querySelector('.date-input').value;
                if (!activityDateStr) { row.style.display = 'none'; return; }
                const activityDate = new Date(activityDateStr);
                const activityWeek = row.querySelector('.week').textContent;
                const activityQuarter = getQuarterFromWeek(parseInt(activityWeek));

                const yearMatch = year === 'all' || activityDate.getUTCFullYear().toString() === year;
                const quarterMatch = quarter === 'all' || activityQuarter === quarter;
                const monthMatch = month === 'all' || activityDate.getUTCMonth().toString() === month;
                const weekMatch = week === 'all' || activityWeek === week;

                row.style.display = (yearMatch && quarterMatch && monthMatch && weekMatch) ? '' : 'none';
            });
            calculateUtilization();
        };
        
        const calculateUtilization = () => {
            const workingHoursPerWeek = parseFloat(document.getElementById('working-hours').value) || 40;
            let totalWorkedHours = 0, billableHoursSum = 0, totalTimeOffHours = 0;
            const weeksInSelection = new Set();
            
            const rowsToConsider = Array.from(document.querySelectorAll('#activity-table tbody tr')).filter(row => row.style.display !== 'none');
            
            rowsToConsider.forEach(row => {
                const type = row.querySelector('.type-select').value;
                const hours = parseFloat(row.querySelector('.total-hours').textContent) || 0;
                weeksInSelection.add(row.querySelector('.week').textContent);
                
                if (type === 'Work') {
                    totalWorkedHours += hours;
                    billableHoursSum += parseFloat(row.querySelector('.billable-hours').textContent) || 0;
                } else {
                    totalTimeOffHours += hours;
                }
            });

            const numWeeks = weeksInSelection.size || 1;
            const totalAvailableHours = (workingHoursPerWeek * numWeeks) - totalTimeOffHours;
            const basedOnText = `Across ${numWeeks} week(s) in selection`;
            
            const effectiveUtilization = (totalWorkedHours > 0 && totalAvailableHours > 0) ? (totalWorkedHours / totalAvailableHours) * 100 : 0;
            const billableUtilization = (totalWorkedHours > 0) ? (billableHoursSum / totalWorkedHours) * 100 : 0;
            
            document.getElementById('utilization-summary').innerHTML = `
                <div class="bg-blue-50 p-4 rounded-lg shadow"><h3 class="text-sm font-medium text-blue-800">Total Hours (Selection)</h3><p class="mt-1 text-3xl font-semibold text-blue-900">${totalWorkedHours.toFixed(1)}</p></div>
                <div class="bg-green-50 p-4 rounded-lg shadow"><h3 class="text-sm font-medium text-green-800">Effective Utilization</h3><p class="mt-1 text-3xl font-semibold text-green-900">${effectiveUtilization.toFixed(1)}%</p><p class="text-xs text-gray-500">${basedOnText}</p></div>
                <div class="bg-purple-50 p-4 rounded-lg shadow"><h3 class="text-sm font-medium text-purple-800">Billable Utilization</h3><p class="mt-1 text-3xl font-semibold text-purple-900">${billableUtilization.toFixed(1)}%</p><p class="text-xs text-gray-500">Of total hours in selection</p></div>`;
        };
        
        const renderActivityTable = () => {
            activityTableBody.innerHTML = '';
            const sortedActivities = [...activitiesCache].sort((a, b) => {
                const dateA = new Date(a.date); const dateB = new Date(b.date);
                return dateSortDirection === 'asc' ? dateA - dateB : dateB - dateA;
            });
            sortedActivities.forEach(activityDoc => {
                const data = activityDoc;
                const row = activityTableBody.insertRow();
                row.dataset.id = data.id;
                row.innerHTML = `
                    <td class="week">${data.week || ''}</td>
                    <td><input type="date" value="${data.date || ''}" class="date-input" min="2025-01-01" max="2100-12-31"></td>
                    <td><select class="type-select"><option value="Work" ${data.type === 'Work' ? 'selected' : ''}>Work</option><option value="PTO" ${data.type === 'PTO' ? 'selected' : ''}>PTO</option><option value="Holiday" ${data.type === 'Holiday' ? 'selected' : ''}>Holiday</option></select></td>
                    <td contenteditable="true">${data.project || ''}</td>
                    <td contenteditable="true">${data.action || ''}</td>
                    <td contenteditable="true">${data.status || 'In Progress'}</td>
                    <td contenteditable="true" class="total-hours">${data.totalHours || 0}</td>
                    <td contenteditable="true" class="billable-hours">${data.billableHours || 0}</td>
                    <td class="text-center"><button class="delete-activity-btn text-red-500 hover:text-red-700 text-xs">Delete</button></td>`;
            });
                filterActivities(); // <--- ADD THIS LINE!
        };
        const toggleDateSort = () => { dateSortDirection = dateSortDirection === 'desc' ? 'asc' : 'desc'; document.getElementById('date-sort-btn').innerHTML = dateSortDirection === 'desc' ? '↓' : '↑'; renderActivityTable(); };
        const addActivityRow = () => addDoc(collection(db, `users/${userId}/activities`), { date: new Date().toISOString().split('T')[0], week: getWeekNumber(new Date()), type: 'Work', project: '', action: '', status: 'New', totalHours: 0, billableHours: 0, createdAt: new Date() });
        const updateActivity = (id, data) => setDoc(doc(db, `users/${userId}/activities`, id), data, { merge: true });
        const deleteActivity = (id) => deleteDoc(doc(db, `users/${userId}/activities`, id));
        
        // --- Objectives Logic ---
        const updateProgress = () => {
            document.querySelectorAll('.summary-table tbody tr').forEach(row => {
                const target = parseFloat(row.cells[2].textContent.replace(/[^0-9.]/g, ''));
                const actual = parseFloat(row.cells[3].textContent.replace(/[^0-9.]/g, ''));
                const progressCell = row.cells[4];
                if (!isNaN(target) && !isNaN(actual) && target > 0) {
                    let progress = Math.min(100, Math.max(0, (actual / target) * 100));
                    let colorClass = progress >= 75 ? 'bg-green-500' : progress >= 40 ? 'bg-yellow-500' : 'bg-red-500';
                    progressCell.innerHTML = `<div class="w-full bg-gray-200 rounded-full h-2.5"><div class="${colorClass} h-2.5 rounded-full" style="width: ${progress}%"></div></div><div class="text-xs text-center text-gray-600 mt-1">${progress.toFixed(0)}%</div>`;
                } else {
                    progressCell.innerHTML = '';
                }
            });
        };
        const populateQuarterFilter = () => {
            const quarterCells = document.querySelectorAll('#summary .quarter-select');
            const quarterFilter = document.getElementById('quarter-filter');
            const uniqueQuarters = new Set(Array.from(quarterCells).map(cell => cell.value).filter(Boolean));
            const currentSelection = quarterFilter.value;
            quarterFilter.innerHTML = '<option value="all">All Quarters</option>';
            Array.from(uniqueQuarters).sort().forEach(q => quarterFilter.innerHTML += `<option value="${q}">${q}</option>`);
            quarterFilter.value = Array.from(quarterFilter.options).some(opt => opt.value === currentSelection) ? currentSelection : 'all';
        };
        const filterSummaryByQuarter = () => {
            const selectedQuarter = document.getElementById('quarter-filter').value;
            document.querySelectorAll('.objective-block').forEach(block => {
                let hasVisibleRows = false;
                block.querySelectorAll('tbody tr').forEach(row => {
                    const rowQuarter = row.querySelector('.quarter-select').value;
                    if (selectedQuarter === 'all' || rowQuarter === selectedQuarter) {
                        row.style.display = ''; hasVisibleRows = true;
                    } else {
                        row.style.display = 'none';
                    }
                });
                block.style.display = hasVisibleRows ? 'block' : 'none';
            });
        };
        const renderQuarterlySummaryCards = () => {
            const workingHoursPerWeek = parseFloat(document.getElementById('working-hours').value) || 40;
            const selectedQuarter = document.getElementById('quarter-filter').value;
            let totalWorkedHours = 0, billableHoursSum = 0, totalTimeOffHours = 0;
            const weeksInSelection = new Set();
            const rowsToConsider = activitiesCache.filter(activity => {
                if (!activity.week) return false;
                if (selectedQuarter === 'all') return true;
                return getQuarterFromWeek(activity.week) === selectedQuarter;
            });
            rowsToConsider.forEach(activity => {
                weeksInSelection.add(activity.week);
                if (activity.type === 'Work') {
                    totalWorkedHours += parseFloat(activity.totalHours) || 0;
                    billableHoursSum += parseFloat(activity.billableHours) || 0;
                } else {
                    totalTimeOffHours += parseFloat(activity.totalHours) || 0;
                }
            });
            const numWeeks = weeksInSelection.size || 1;
            const totalAvailableHours = (workingHoursPerWeek * numWeeks) - totalTimeOffHours;
            const basedOnText = selectedQuarter === 'all' ? `Across all quarters` : `Across ${numWeeks} week(s) in ${selectedQuarter}`;
            const effectiveUtilization = (totalWorkedHours > 0 && totalAvailableHours > 0) ? (totalWorkedHours / totalAvailableHours) * 100 : 0;
            const billableUtilization = (totalWorkedHours > 0) ? (billableHoursSum / totalWorkedHours) * 100 : 0;
            let totalProgress = 0, krCount = 0;
            objectivesCache.forEach(objDoc => {
                const objectiveData = objDoc.data();
                (objectiveData.krs || []).forEach(kr => {
                    const krQuarter = kr.quarter || '';
                    if (selectedQuarter === 'all' || krQuarter === selectedQuarter) {
                        const target = parseFloat(kr.target);
                        const actual = parseFloat(kr.actual);
                        if (!isNaN(target) && !isNaN(actual) && target > 0) {
                            totalProgress += Math.min(100, Math.max(0, (actual / target) * 100));
                            krCount++;
                        }
                    }
                });
            });
            const averageOkrProgress = krCount > 0 ? totalProgress / krCount : 0;
            document.getElementById('quarterly-summary-cards').innerHTML = `
                <div class="bg-blue-50 p-4 rounded-lg shadow"><h3 class="text-sm font-medium text-blue-800">Total Hours (${selectedQuarter})</h3><p class="mt-1 text-3xl font-semibold text-blue-900">${totalWorkedHours.toFixed(1)}</p></div>
                <div class="bg-green-50 p-4 rounded-lg shadow"><h3 class="text-sm font-medium text-green-800">Effective Utilization</h3><p class="mt-1 text-3xl font-semibold text-green-900">${effectiveUtilization.toFixed(1)}%</p><p class="text-xs text-gray-500">${basedOnText}</p></div>
                <div class="bg-purple-50 p-4 rounded-lg shadow"><h3 class="text-sm font-medium text-purple-800">Billable Utilization</h3><p class="mt-1 text-3xl font-semibold text-purple-900">${billableUtilization.toFixed(1)}%</p><p class="text-xs text-gray-500">Of total hours in selection</p></div>
                <div class="bg-yellow-50 p-4 rounded-lg shadow"><h3 class="text-sm font-medium text-yellow-800">Overall OKR Progress</h3><p class="mt-1 text-3xl font-semibold text-yellow-900">${averageOkrProgress.toFixed(0)}%</p><p class="text-xs text-gray-500">Avg. of ${krCount} KRs in selection</p></div>`;
        };
        const handleQuarterFilterChange = () => { filterSummaryByQuarter(); renderQuarterlySummaryCards(); };
        const renderObjectives = () => {
            objectivesContainer.innerHTML = '';
            objectivesCache.forEach((doc, index) => {
                const data = doc.data();
                const block = document.createElement('div');
                block.className = 'objective-block';
                block.dataset.id = doc.id;
                const krsHTML = (data.krs || []).map((kr, i) => `
                    <tr data-index="${i}">
                        <td><select class="quarter-select"><option value="Q1" ${kr.quarter === 'Q1' ? 'selected' : ''}>Q1</option><option value="Q2" ${kr.quarter === 'Q2' ? 'selected' : ''}>Q2</option><option value="Q3" ${kr.quarter === 'Q3' ? 'selected' : ''}>Q3</option><option value="Q4" ${kr.quarter === 'Q4' ? 'selected' : ''}>Q4</option></select></td>
                        <td contenteditable="true">${kr.result || ''}</td>
                        <td contenteditable="true">${kr.target || ''}</td>
                        <td contenteditable="true" class="actual">${kr.actual || ''}</td>
                        <td class="progress"></td>
                        <td contenteditable="true">${kr.notes || ''}</td>
                        <td class="text-center"><button class="delete-kr-btn text-red-500 text-xs">Delete</button></td>
                    </tr>`).join('');
                block.innerHTML = `
                    <div class="bg-gray-100 p-4 rounded-lg flex justify-between items-center">
                        <div class="flex items-center">
                            <div class="flex flex-col mr-4">
                                ${index > 0 ? `<svg class="control-arrow h-5 w-5 text-gray-500 move-up" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>` : `<div class="h-5 w-5"></div>`}
                                ${index < objectivesCache.length - 1 ? `<svg class="control-arrow h-5 w-5 text-gray-500 move-down" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>` : `<div class="h-5 w-5"></div>`}
                            </div>
                            <h3 contenteditable="true" class="font-bold text-lg text-gray-800">${data.title}</h3>
                        </div>
                        <button class="delete-objective-btn text-red-500 text-xs hover:underline">Delete Objective</button>
                    </div>
                    <div class="table-container mt-2">
                        <table class="min-w-full summary-table">
                            <thead class="bg-gray-50"><tr><th>Quarter</th><th>Key Result</th><th>Target</th><th>Actual</th><th>Progress</th><th>Key Achievements & Notes</th><th>Actions</th></tr></thead>
                            <tbody>${krsHTML}</tbody>
                        </table>
                        <button class="add-kr-btn mt-2 bg-gray-100 text-xs">+ Add Key Result</button>
                    </div>`;
                objectivesContainer.appendChild(block);
            });
            updateProgress();
            populateQuarterFilter();
            filterSummaryByQuarter();
        };
        const addObjective = () => { const newOrder = objectivesCache.length > 0 ? Math.max(...objectivesCache.map(o => o.data().order || 0)) + 1 : 0; addDoc(collection(db, `users/${userId}/objectives`), { title: 'New Objective', krs: [{ quarter: getQuarterFromDate(new Date()), result: '', target: '', actual: '', notes: '' }], order: newOrder, createdAt: new Date() }); };
        const updateObjective = (id, data) => setDoc(doc(db, `users/${userId}/objectives`, id), data, { merge: true });
        const deleteObjective = (id) => deleteDoc(doc(db, `users/${userId}/objectives`, id));
        const addKR = (id, krs) => updateObjective(id, { krs: [...krs, { quarter: getQuarterFromDate(new Date()), result: '', target: '', actual: '', notes: '' }] });
        const deleteKR = (id, krs, index) => updateObjective(id, { krs: krs.filter((_, i) => i !== index) });
        const moveObjective = async (index, direction) => {
            const batch = writeBatch(db);
            const currentObj = objectivesCache[index];
            const swapIndex = direction === 'up' ? index - 1 : index + 1;
            const swapObj = objectivesCache[swapIndex];
            if (swapObj) {
                const currentOrder = currentObj.data().order;
                const swapOrder = swapObj.data().order;
                batch.update(doc(db, `users/${userId}/objectives`, currentObj.id), { order: swapOrder });
                batch.update(doc(db, `users/${userId}/objectives`, swapObj.id), { order: currentOrder });
                await batch.commit();
            }
        };

        // --- Firebase Initialization and Auth ---
        async function seedInitialData(userId) {
            const objectivesRef = collection(db, `users/${userId}/objectives`);
            const objectivesSnapshot = await getDocs(query(objectivesRef));
            if (objectivesSnapshot.empty) {
                const batch = writeBatch(db);
                const activitiesRef = collection(db, `users/${userId}/activities`);
                const sampleActivities = [
                    { date: '2025-07-02', week: 27, type: 'Work', project: 'Project Alpha', action: 'Initial user research and summarized findings.', status: 'Completed', totalHours: 8, billableHours: 8, createdAt: new Date() },
                    { date: '2025-07-04', week: 27, type: 'Holiday', project: 'National Holiday', action: '4th of July', status: 'Completed', totalHours: 8, billableHours: 0, createdAt: new Date() },
                    { date: '2025-07-08', week: 28, type: 'Work', project: 'Project Beta', action: 'Kick-off meeting and requirements gathering.', status: 'In Progress', totalHours: 6, billableHours: 6, createdAt: new Date() }
                ];
                sampleActivities.forEach(activity => { batch.set(doc(activitiesRef), activity); });
                const sampleObjectives = [
                    { title: "Drive High-Impact Project Delivery", order: 0, createdAt: new Date(), krs: [ { quarter: "Q3", result: "Achieve >85% billable utilization.", target: "85", actual: "88", notes: "Consistently billed over 34 hours per week." }, { quarter: "Q3", result: "Successfully deliver all milestones for Project Alpha on or before the deadline.", target: "100", actual: "100", notes: "Phase 1 & 2 completed." } ] },
                    { title: "Enhance Professional Skills", order: 1, createdAt: new Date(), krs: [ { quarter: "Q3", result: "Complete 2 professional development courses.", target: "2", actual: "1", notes: "Completed Data Viz course. Scheduled PM course." }, { quarter: "Q4", result: "Mentor one junior team member.", target: "1", actual: "0", notes: "Scheduled first session with Alex." } ] }
                ];
                sampleObjectives.forEach(obj => { batch.set(doc(objectivesRef), obj); });
                await batch.commit();
            }
        }
        
        async function initialize() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Event Delegation for dynamic content
                document.body.addEventListener('click', (e) => {
                    const target = e.target;
                    if (target.closest('.objective-block')) {
                        const objectiveBlock = target.closest('.objective-block');
                        const docId = objectiveBlock.dataset.id;
                        const objIndex = objectivesCache.findIndex(d => d.id === docId);
                        if (target.classList.contains('delete-objective-btn')) deleteObjective(docId);
                        else if (target.classList.contains('add-kr-btn')) addKR(docId, objectivesCache[objIndex].data().krs || []);
                        else if (target.closest('.move-up')) moveObjective(objIndex, 'up');
                        else if (target.closest('.move-down')) moveObjective(objIndex, 'down');
                        else if (target.classList.contains('delete-kr-btn')) {
                            const krIndex = parseInt(target.closest('tr').dataset.index);
                            deleteKR(docId, objectivesCache[objIndex].data().krs || [], krIndex);
                        }
                    } else if (target.closest('#activity-table') && target.classList.contains('delete-activity-btn')) {
                        const row = target.closest('tr');
                        if (row) deleteActivity(row.dataset.id);
                    }
                });

                document.body.addEventListener('blur', (e) => {
                    const target = e.target;
                    if (target.closest('.objective-block')) {
                        const block = target.closest('.objective-block');
                        const docId = block.dataset.id;
                        const objIndex = objectivesCache.findIndex(d => d.id === docId);
                        if (target.tagName === 'H3') {
                            updateObjective(docId, { title: target.textContent });
                        } else if (target.closest('tr')) {
                            const krIndex = parseInt(target.closest('tr').dataset.index);
                            const cellIndex = target.closest('td').cellIndex;
                            const field = { 1: 'result', 2: 'target', 3: 'actual', 5: 'notes' }[cellIndex];
                            if(field) {
                                const krs = objectivesCache[objIndex].data().krs || [];
                                krs[krIndex][field] = target.textContent;
                                updateObjective(docId, { krs });
                            }
                        }
                    } else if (target.closest('#activity-table')) {
                        const row = target.closest('tr');
                        if (!row) return;
                        const docId = row.dataset.id;
                        const cellIndex = target.closest('td').cellIndex;
                        const fieldMap = { 3: 'project', 4: 'action', 5: 'status', 6: 'totalHours', 7: 'billableHours' };
                        const field = fieldMap[cellIndex];
                        if (field) updateActivity(docId, { [field]: target.textContent });
                    }
                }, true);

                document.body.addEventListener('change', (e) => {
                    const target = e.target;
                    if (target.closest('.objective-block') && target.classList.contains('quarter-select')) {
                        const block = target.closest('.objective-block');
                        const krRow = target.closest('tr');
                        const docId = block.dataset.id;
                        const objIndex = objectivesCache.findIndex(d => d.id === docId);
                        const krIndex = parseInt(krRow.dataset.index);
                        const krs = objectivesCache[objIndex].data().krs || [];
                        krs[krIndex]['quarter'] = target.value;
                        updateObjective(docId, { krs });
                    } else if (target.closest('#activity-table') && target.classList.contains('type-select')) {
                        const row = target.closest('tr');
                        updateActivity(row.dataset.id, { type: target.value });
                    } else if (target.closest('#activity-table') && target.classList.contains('date-input')) {
                         const row = target.closest('tr');
                         const date = new Date(target.value);
                         const week = isNaN(date.getTime()) ? '' : getWeekNumber(date);
                         updateActivity(row.dataset.id, { date: target.value, week: week });
                    }
                });

                // Static Listeners
                document.getElementById('google-signin-btn').addEventListener('click', signInWithGoogle);
                document.getElementById('guest-signin-btn').addEventListener('click', () => signInAnonymously(auth));
                document.getElementById('sign-out-btn').addEventListener('click', signOutUser);
                document.getElementById('email-form').addEventListener('submit', handleEmailAuth);
                document.getElementById('form-toggle-btn').addEventListener('click', toggleAuthForm);
                document.getElementById('add-activity-row-btn').addEventListener('click', addActivityRow);
                document.getElementById('add-objective-btn').addEventListener('click', addObjective);
                document.getElementById('date-sort-btn').addEventListener('click', toggleDateSort);
                document.getElementById('year-filter').addEventListener('change', () => { populateDateFilters(); filterActivities(); });
                document.getElementById('quarter-activity-filter').addEventListener('change', filterActivities);
                document.getElementById('month-filter').addEventListener('change', filterActivities);
                document.getElementById('week-filter').addEventListener('change', filterActivities);
                document.getElementById('quarter-filter').addEventListener('change', handleQuarterFilterChange);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userName').textContent = user.displayName || (user.isAnonymous ? 'Guest' : user.email);
                        showLoader();
                        await seedInitialData(userId);
                        if (activitiesUnsubscribe) activitiesUnsubscribe();
                        if (objectivesUnsubscribe) objectivesUnsubscribe();
                        const activitiesQuery = query(collection(db, `users/${userId}/activities`));
                        activitiesUnsubscribe = onSnapshot(activitiesQuery, snapshot => {
                            activitiesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            renderActivityTable();
                            populateDateFilters();
                            renderQuarterlySummaryCards();
                        });
                        const objectivesQuery = query(collection(db, `users/${userId}/objectives`), orderBy("order"));
                        objectivesUnsubscribe = onSnapshot(objectivesQuery, snapshot => {
                            objectivesCache = snapshot.docs;
                            renderObjectives();
                            renderQuarterlySummaryCards();
                        });
                        showApp();
                    } else {
                        if (activitiesUnsubscribe) activitiesUnsubscribe();
                        if (objectivesUnsubscribe) objectivesUnsubscribe();
                        activitiesCache = []; objectivesCache = [];
                        showLogin();
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                loader.innerHTML = "Failed to load application. Check console for errors.";
            }
        }

        initialize();
    </script>
</body>
</html>
