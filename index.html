<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live OKR Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .tab-button.active { border-color: #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        [contenteditable="true"]:focus { outline: 2px solid #4f46e5; background-color: #fff; border-radius: 4px; }
        th, td { border: 1px solid #e5e7eb; padding: 12px; text-align: left; }
        th { background-color: #f9fafb; font-weight: 600; }
        .table-container { overflow-x: auto; }
        .add-row-btn { transition: all 0.2s ease-in-out; }
        .add-row-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .date-input { background-color: transparent; border: none; padding: 0; width: 100%; min-width: 130px; }
        .date-input:focus { outline: none; box-shadow: none; }
        #loader { display: flex; }
        .control-arrow { cursor: pointer; }
        .control-arrow:hover { color: #4f46e5; }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <!-- Loading Spinner -->
    <div id="loader" class="fixed inset-0 bg-white bg-opacity-75 z-50 justify-center items-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div>
    </div>

    <div id="app-content" class="max-w-7xl mx-auto bg-white p-6 rounded-2xl shadow-lg hidden">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">My OKR Tracker</h1>
                <p class="mt-1 text-gray-500">Track activities and summarize quarterly achievements.</p>
            </div>
            <div class="mt-4 sm:mt-0 text-right">
                <span id="currentDate" class="text-sm text-gray-500 block"></span>
                <div class="text-xs text-gray-400 mt-1">User ID: <span id="userId" class="font-mono"></span></div>
            </div>
        </div>

        <!-- Tab Buttons -->
        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                <button onclick="changeTab(event, 'activity')" class="tab-button active whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-lg">Activity Tracker</button>
                <button onclick="changeTab(event, 'summary')" class="tab-button whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-lg">Quarterly Summary</button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div>
            <!-- Activity Tracker Tab -->
            <div id="activity" class="tab-content active">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-xl font-semibold text-gray-700">Weekly Activity Log</h2>
                    <div class="flex items-center space-x-2 sm:space-x-4">
                        <div class="text-sm"><label for="year-filter" class="font-medium text-gray-600">Year:</label><select id="year-filter" class="p-2 border rounded-md bg-white"></select></div>
                        <div class="text-sm"><label for="month-filter" class="font-medium text-gray-600">Month:</label><select id="month-filter" class="p-2 border rounded-md bg-white"></select></div>
                        <div class="text-sm"><label for="week-filter" class="font-medium text-gray-600">Week:</label><select id="week-filter" class="p-2 border rounded-md bg-white"></select></div>
                        <div class="text-sm"><label for="working-hours" class="font-medium text-gray-600">Weekly Hours:</label><input type="number" id="working-hours" value="40" class="w-20 p-2 border rounded-md text-center"></div>
                        <button onclick="calculateUtilization()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Calculate</button>
                    </div>
                </div>
                <div id="utilization-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div>
                <div class="table-container">
                    <table id="activity-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr><th>Week</th><th>Date</th><th>Project / Work-stream</th><th>Action / Task Completed</th><th>Status</th><th>Total Hours</th><th>Billable Hours</th><th>Actions</th></tr></thead>
                        <tbody class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <button id="add-activity-row-btn" class="add-row-btn mt-4 bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg hover:bg-indigo-200"> + Add Activity Row </button>
            </div>

            <!-- Quarterly Summary Tab -->
            <div id="summary" class="tab-content">
                 <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-xl font-semibold text-gray-700">Quarterly Achievements Summary</h2>
                    <div class="text-sm"><label for="quarter-filter" class="font-medium text-gray-600">Filter by Quarter:</label><select id="quarter-filter" onchange="handleQuarterFilterChange()" class="p-2 border rounded-md bg-white"></select></div>
                 </div>
                 <div id="quarterly-utilization-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div>
                 <div id="objectives-container" class="space-y-8"></div>
                 <button id="add-objective-btn" class="add-row-btn mt-6 bg-green-100 text-green-800 px-4 py-2 rounded-lg hover:bg-green-200">+ Add New Objective</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, setDoc, deleteDoc, onSnapshot, query, getDocs, writeBatch, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAAhK518n0CoogsD84u_5Wa65IQrnphpbg",
            authDomain: "my-okr-tracker-a77ed.firebaseapp.com",
            projectId: "my-okr-tracker-a77ed",
            storageBucket: "my-okr-tracker-a77ed.appspot.com",
            messagingSenderId: "344615597808",
            appId: "1:344615597808:web:a976849992dc0f9a5d3435",
            measurementId: "G-BQW8HWHBM3"
        };

        // --- App State ---
        let db, auth, userId;
        let activitiesUnsubscribe, objectivesUnsubscribe;
        let objectivesCache = [];
        let activitiesCache = [];

        // --- General UI ---
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        window.changeTab = (event, tabID) => {
            document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = "none");
            document.querySelectorAll('.tab-button').forEach(tb => tb.classList.remove('active'));
            document.getElementById(tabID).style.display = "block";
            event.currentTarget.classList.add('active');
        };

        // --- Activity Tracker UI & Logic ---
        const activityTableBody = document.getElementById('activity-table').querySelector('tbody');
        
        const getWeekNumber = (d) => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        };
        
        const getQuarterFromWeek = (week) => {
            if (week <= 13) return 'Q1';
            if (week <= 26) return 'Q2';
            if (week <= 39) return 'Q3';
            return 'Q4';
        };

        const populateDateFilters = () => {
            const yearFilter = document.getElementById('year-filter');
            const monthFilter = document.getElementById('month-filter');
            const weekFilter = document.getElementById('week-filter');

            const years = new Set();
            const months = new Set();
            const weeks = new Set();

            const selectedYear = yearFilter.value;
            const selectedMonth = monthFilter.value;

            activitiesCache.forEach(activity => {
                if (!activity.date) return;
                const date = new Date(activity.date);
                const year = date.getFullYear();
                years.add(year);

                if (selectedYear === 'all' || year.toString() === selectedYear) {
                    const month = date.getMonth(); // 0-11
                    months.add(month);
                    if (selectedMonth === 'all' || month.toString() === selectedMonth) {
                        weeks.add(activity.week);
                    }
                }
            });

            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

            const populate = (select, options, allLabel, isMonth = false) => {
                const currentValue = select.value;
                select.innerHTML = `<option value="all">${allLabel}</option>`;
                Array.from(options).sort((a,b) => a-b).forEach(opt => {
                    select.innerHTML += `<option value="${opt}">${isMonth ? monthNames[opt] : opt}</option>`;
                });
                select.value = currentValue;
            };

            populate(yearFilter, years, 'All Years');
            populate(monthFilter, months, 'All Months', true);
            populate(weekFilter, weeks, 'All Weeks');
        };

        const filterActivities = () => {
            const year = document.getElementById('year-filter').value;
            const month = document.getElementById('month-filter').value;
            const week = document.getElementById('week-filter').value;

            document.querySelectorAll('#activity-table tbody tr').forEach(row => {
                const activityDate = new Date(row.cells[1].querySelector('input').value);
                const activityWeek = row.cells[0].textContent;

                const yearMatch = year === 'all' || activityDate.getFullYear().toString() === year;
                const monthMatch = month === 'all' || activityDate.getMonth().toString() === month;
                const weekMatch = week === 'all' || activityWeek === week;

                row.style.display = (yearMatch && monthMatch && weekMatch) ? '' : 'none';
            });
            calculateUtilization();
        };
        
        window.calculateUtilization = () => {
            const workingHoursPerWeek = parseFloat(document.getElementById('working-hours').value) || 40;
            let totalHoursSum = 0, billableHoursSum = 0;
            const rowsToConsider = Array.from(document.querySelectorAll('#activity-table tbody tr')).filter(row => row.style.display !== 'none');
            
            rowsToConsider.forEach(row => {
                totalHoursSum += parseFloat(row.querySelector('.total-hours').textContent) || 0;
                billableHoursSum += parseFloat(row.querySelector('.billable-hours').textContent) || 0;
            });

            const numWeeks = new Set(rowsToConsider.map(r => r.querySelector('.week')?.textContent.trim()).filter(Boolean)).size || 1;
            const effectiveWorkingHours = workingHoursPerWeek * numWeeks;
            const basedOnText = `Across ${numWeeks} week(s) in selection`;
            
            const effectiveUtilization = (totalHoursSum > 0 && effectiveWorkingHours > 0) ? (totalHoursSum / effectiveWorkingHours) * 100 : 0;
            const billableUtilization = (totalHoursSum > 0) ? (billableHoursSum / totalHoursSum) * 100 : 0;
            
            document.getElementById('utilization-summary').innerHTML = `
                <div class="bg-blue-50 p-4 rounded-lg shadow"><h3 class="text-sm font-medium text-blue-800">Total Hours (Selection)</h3><p class="mt-1 text-3xl font-semibold text-blue-900">${totalHoursSum.toFixed(1)}</p></div>
                <div class="bg-green-50 p-4 rounded-lg shadow"><h3 class="text-sm font-medium text-green-800">Effective Utilization</h3><p class="mt-1 text-3xl font-semibold text-green-900">${effectiveUtilization.toFixed(1)}%</p><p class="text-xs text-gray-500">${basedOnText}</p></div>
                <div class="bg-purple-50 p-4 rounded-lg shadow"><h3 class="text-sm font-medium text-purple-800">Billable Utilization</h3><p class="mt-1 text-3xl font-semibold text-purple-900">${billableUtilization.toFixed(1)}%</p><p class="text-xs text-gray-500">Of total hours in selection</p></div>`;
        };

        const renderActivityRow = (doc) => {
            const data = doc.data();
            let row = activityTableBody.querySelector(`[data-id="${doc.id}"]`);
            if (!row) {
                row = activityTableBody.insertRow(-1);
                row.dataset.id = doc.id;
            }
            row.innerHTML = `
                <td class="week">${data.week || ''}</td>
                <td><input type="date" value="${data.date || ''}" class="date-input"></td>
                <td contenteditable="true">${data.project || ''}</td>
                <td contenteditable="true">${data.action || ''}</td>
                <td contenteditable="true">${data.status || 'In Progress'}</td>
                <td contenteditable="true" class="total-hours">${data.totalHours || 0}</td>
                <td contenteditable="true" class="billable-hours">${data.billableHours || 0}</td>
                <td class="text-center"><button class="text-red-500 hover:text-red-700 text-xs">Delete</button></td>
            `;
            row.querySelector('.date-input').addEventListener('change', (e) => {
                const date = new Date(e.target.value);
                const week = isNaN(date.getTime()) ? '' : getWeekNumber(date);
                updateActivity(doc.id, { date: e.target.value, week: week });
            });
            row.querySelectorAll('[contenteditable="true"]').forEach((cell, i) => {
                cell.addEventListener('blur', (e) => {
                    const field = ['project', 'action', 'status', 'totalHours', 'billableHours'][i];
                    updateActivity(doc.id, { [field]: e.target.textContent });
                });
            });
            row.querySelector('button').addEventListener('click', () => deleteActivity(doc.id));
        };

        const addActivityRow = () => addDoc(collection(db, `users/${userId}/activities`), {
            date: new Date().toISOString().split('T')[0], week: getWeekNumber(new Date()), project: '', action: '', 
            status: 'New', totalHours: 0, billableHours: 0
        });
        const updateActivity = (id, data) => setDoc(doc(db, `users/${userId}/activities`, id), data, { merge: true });
        const deleteActivity = (id) => deleteDoc(doc(db, `users/${userId}/activities`, id));
        
        // --- Objectives UI & Logic ---
        const objectivesContainer = document.getElementById('objectives-container');

        const updateProgress = () => { /* ... (same as before) ... */ };
        const populateQuarterFilter = () => { /* ... (same as before) ... */ };
        window.filterSummaryByQuarter = () => { /* ... (same as before) ... */ };
        
        window.calculateQuarterlySummaryStats = () => {
            const workingHoursPerWeek = parseFloat(document.getElementById('working-hours').value) || 40;
            const selectedQuarter = document.getElementById('quarter-filter').value;
            
            let totalHoursSum = 0, billableHoursSum = 0;
            const rowsToConsider = activitiesCache.filter(activity => {
                if (!activity.week) return false;
                if (selectedQuarter === 'all') return true;
                return getQuarterFromWeek(activity.week) === selectedQuarter;
            });

            rowsToConsider.forEach(activity => {
                totalHoursSum += parseFloat(activity.totalHours) || 0;
                billableHoursSum += parseFloat(activity.billableHours) || 0;
            });

            const numWeeks = new Set(rowsToConsider.map(r => r.week)).size || 1;
            const effectiveWorkingHours = workingHoursPerWeek * numWeeks;
            const basedOnText = selectedQuarter === 'all' ? `Across all quarters` : `Across ${numWeeks} week(s) in ${selectedQuarter}`;
            
            const effectiveUtilization = (totalHoursSum > 0 && effectiveWorkingHours > 0) ? (totalHoursSum / effectiveWorkingHours) * 100 : 0;
            const billableUtilization = (totalHoursSum > 0) ? (billableHoursSum / totalHoursSum) * 100 : 0;
            
            document.getElementById('quarterly-utilization-summary').innerHTML = `
                <div class="bg-blue-50 p-4 rounded-lg shadow"><h3 class="text-sm font-medium text-blue-800">Total Hours (${selectedQuarter})</h3><p class="mt-1 text-3xl font-semibold text-blue-900">${totalHoursSum.toFixed(1)}</p></div>
                <div class="bg-green-50 p-4 rounded-lg shadow"><h3 class="text-sm font-medium text-green-800">Effective Utilization</h3><p class="mt-1 text-3xl font-semibold text-green-900">${effectiveUtilization.toFixed(1)}%</p><p class="text-xs text-gray-500">${basedOnText}</p></div>
                <div class="bg-purple-50 p-4 rounded-lg shadow"><h3 class="text-sm font-medium text-purple-800">Billable Utilization</h3><p class="mt-1 text-3xl font-semibold text-purple-900">${billableUtilization.toFixed(1)}%</p><p class="text-xs text-gray-500">Of total hours in selection</p></div>`;
        };

        window.handleQuarterFilterChange = () => {
            filterSummaryByQuarter();
            calculateQuarterlySummaryStats();
        };

        const renderObjectiveBlock = (doc, index, total) => { /* ... (same as before) ... */ };
        const addObjective = () => { /* ... (same as before) ... */ };
        const updateObjective = (id, data) => setDoc(doc(db, `users/${userId}/objectives`, id), data, { merge: true });
        const deleteObjective = (id) => deleteDoc(doc(db, `users/${userId}/objectives`, id));
        const addKR = (id, krs) => updateObjective(id, { krs: [...krs, { quarter: 'Q3', result: '', target: '', actual: '', notes: '' }] });
        const deleteKR = (id, krs, index) => updateObjective(id, { krs: krs.filter((_, i) => i !== index) });
        const moveObjective = async (index, direction) => { /* ... (same as before) ... */ };

        // --- Firebase Initialization and Auth ---
        
        async function seedInitialData(userId) { /* ... (same as before) ... */ }

        async function initialize() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Programmatic event listeners
                document.getElementById('add-activity-row-btn').addEventListener('click', addActivityRow);
                document.getElementById('add-objective-btn').addEventListener('click', addObjective);
                document.getElementById('year-filter').addEventListener('change', () => {
                    populateDateFilters();
                    filterActivities();
                });
                document.getElementById('month-filter').addEventListener('change', () => {
                    populateDateFilters();
                    filterActivities();
                });
                document.getElementById('week-filter').addEventListener('change', filterActivities);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userId').textContent = userId.substring(0, 8);
                        
                        await seedInitialData(userId);
                        
                        document.getElementById('loader').style.display = 'none';
                        document.getElementById('app-content').classList.remove('hidden');
                        
                        if (activitiesUnsubscribe) activitiesUnsubscribe();
                        if (objectivesUnsubscribe) objectivesUnsubscribe();

                        const activitiesQuery = query(collection(db, `users/${userId}/activities`));
                        activitiesUnsubscribe = onSnapshot(activitiesQuery, snapshot => {
                            activitiesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            activityTableBody.innerHTML = '';
                            activitiesCache.forEach(activityDoc => renderActivityRow({ id: activityDoc.id, data: () => activityDoc }));
                            populateDateFilters();
                            filterActivities();
                            calculateQuarterlySummaryStats();
                        });

                        const objectivesQuery = query(collection(db, `users/${userId}/objectives`), orderBy("order"));
                        objectivesUnsubscribe = onSnapshot(objectivesQuery, snapshot => {
                            objectivesCache = snapshot.docs;
                            objectivesContainer.innerHTML = '';
                            snapshot.docs.forEach((doc, index) => renderObjectiveBlock(doc, index, snapshot.docs.length));
                            populateQuarterFilter();
                            filterSummaryByQuarter();
                            updateProgress();
                            calculateQuarterlySummaryStats();
                        });

                    } else {
                        document.getElementById('loader').style.display = 'flex';
                        document.getElementById('app-content').classList.add('hidden');
                    }
                });

                await signInAnonymously(auth);

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('loader').innerHTML = "Failed to load application. Check console for errors and ensure Firebase config is correct.";
            }
        }

        initialize();
    </script>
</body>
</html>
